# RAG è©•ä¾¡ã‚¹ã‚¯ãƒªãƒ—ãƒˆ - SSRãƒ„ãƒ¼ãƒ«ç”¨

SSRãƒ„ãƒ¼ãƒ«ã®RAGæ¤œç´¢ç²¾åº¦ã‚’è©•ä¾¡ã™ã‚‹ãŸã‚ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã§ã™ã€‚

## ğŸ¯ ç‰¹å¾´

- **å®Ÿéš›ã®ãƒ„ãƒ¼ãƒ«ã¨åŒã˜ãƒ­ã‚¸ãƒƒã‚¯**: `CustomStakeholderQueryEnhancer` ã§ã‚¯ã‚¨ãƒªã‚’è‡ªå‹•ç”Ÿæˆ
- **å‹•çš„Kå€¤è¨ˆç®—**: ã‚¹ãƒ†ãƒ¼ã‚¯ãƒ›ãƒ«ãƒ€ãƒ¼ã¨ãƒãƒ£ãƒ³ã‚¯æ•°ã«åŸºã¥ã„ã¦æœ€é©ãªKå€¤ã‚’è‡ªå‹•è¨ˆç®—
- **RRFæ¤œç´¢**: è¤‡æ•°ã‚¯ã‚¨ãƒªã‚’Reciprocal Rank Fusionã§çµ±åˆ
- **7ã¤ã®è©•ä¾¡æŒ‡æ¨™**: Precision@K, Recall@K, F1@K, MRR, nDCG@K, Coverage, Kå€¤é”æˆç‡

---

## ğŸ“Š å‹•çš„Kå€¤è¨ˆç®—

SSRãƒ„ãƒ¼ãƒ«ã¨åŒã˜ãƒ­ã‚¸ãƒƒã‚¯ã§Kå€¤ã‚’è‡ªå‹•è¨ˆç®—ã—ã¾ã™ï¼š

```
K = min(50, max(5, totalChunks Ã— 0.3 Ã— roleMultiplier))
```

| ã‚¹ãƒ†ãƒ¼ã‚¯ãƒ›ãƒ«ãƒ€ãƒ¼ | roleMultiplier | èª¬æ˜ |
|------------------|----------------|------|
| technical-fellows, architect, r-and-d | 1.2 | æŠ€è¡“ç³»ï¼šå¤šã‚ã«å‚ç…§ |
| cxo, business | 0.7 | ãƒ“ã‚¸ãƒã‚¹ç³»ï¼šè¦ç‚¹ã‚’çµã‚‹ |
| product | 1.0 | ãƒãƒ©ãƒ³ã‚¹å‹ |
| custom_* | è‡ªå‹•åˆ¤å®š | ãƒ­ãƒ¼ãƒ«åã‹ã‚‰æ¨æ¸¬ |

**ä¾‹**: ç·ãƒãƒ£ãƒ³ã‚¯100ä»¶ã€æŠ€è¡“ãƒ•ã‚§ãƒ­ãƒ¼ã®å ´åˆ
- baseK = 100 Ã— 0.3 = 30
- finalK = min(50, max(5, 30 Ã— 1.2)) = 36

---

## ğŸ“‹ è©•ä¾¡ãƒ•ãƒ­ãƒ¼

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â‘  ãƒŠãƒ¬ãƒƒã‚¸ãƒ™ãƒ¼ã‚¹æ§‹ç¯‰ï¼ˆSSRãƒ„ãƒ¼ãƒ«å´ï¼‰                            â”‚
â”‚     - å„ã‚¹ãƒ†ãƒ¼ã‚¯ãƒ›ãƒ«ãƒ€ãƒ¼ã®namespaceã«24å€‹ã®PDFã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â‘¡ TSVå‡ºåŠ›ï¼ˆæ‰‹å‹•ã§CLIå®Ÿè¡Œï¼‰                                     â”‚
â”‚     npx ts-node rag-evaluator.ts export-tsv \                   â”‚
â”‚       --namespace <namespace> \                                  â”‚
â”‚       --stakeholders ./stakeholders.json                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â‘¢ ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã§ãƒ©ãƒ™ãƒªãƒ³ã‚°ï¼ˆäººæ‰‹ä½œæ¥­ï¼‰                     â”‚
â”‚     - TSVã‚’Google Sheetsã«ã‚¤ãƒ³ãƒãƒ¼ãƒˆ                             â”‚
â”‚     - relevance_scoreåˆ—ã«0ã€œ3ã‚’å…¥åŠ›                              â”‚
â”‚     - TSVã¨ã—ã¦ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â‘£ Ground Truth JSONå¤‰æ›ï¼ˆæ‰‹å‹•ã§CLIå®Ÿè¡Œï¼‰                       â”‚
â”‚     npx ts-node rag-evaluator.ts convert-tsv \                   â”‚
â”‚       --input ./labeled.tsv \                                    â”‚
â”‚       --output ./ground-truth.json                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â‘¤ è©•ä¾¡å®Ÿè¡Œï¼ˆæ‰‹å‹•ã§CLIå®Ÿè¡Œï¼‰                                    â”‚
â”‚     npx ts-node rag-evaluator.ts evaluate-rrf \                  â”‚
â”‚       --namespace <namespace> \                                  â”‚
â”‚       --stakeholders ./stakeholders.json \                       â”‚
â”‚       --ground-truth ./ground-truth.json                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ“Š è©•ä¾¡çµæœå‡ºåŠ›                                                 â”‚
â”‚     - evaluation-rrf-result-{timestamp}.json                     â”‚
â”‚     - evaluation-rrf-report-{timestamp}.txt                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸš€ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

### 1. ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

```bash
cd rag-evaluation
npm install
```

### 2. ç’°å¢ƒå¤‰æ•°ã®è¨­å®š

`.env.local` ã¾ãŸã¯ç’°å¢ƒå¤‰æ•°ã§ä»¥ä¸‹ã‚’è¨­å®šï¼š

```bash
PINECONE_API_KEY=your_pinecone_api_key
OPENAI_API_KEY=your_openai_api_key
PINECONE_INDEX_NAME=ssr-knowledge-base
```

---

## ğŸ“– ã‚³ãƒãƒ³ãƒ‰ä¸€è¦§

### export-tsv - TSVå‡ºåŠ›ï¼ˆãƒ©ãƒ™ãƒªãƒ³ã‚°ç”¨ï¼‰

Pineconeã«æ¤œç´¢ã‚’å®Ÿè¡Œã—ã€ãƒãƒ£ãƒ³ã‚¯ä¸€è¦§ã‚’TSVå½¢å¼ã§å‡ºåŠ›ã—ã¾ã™ã€‚
**Kå€¤ã¯è‡ªå‹•è¨ˆç®—ã•ã‚Œã¾ã™ï¼ˆ--k ã§å›ºå®šå€¤ã‚’æŒ‡å®šã™ã‚‹ã“ã¨ã‚‚å¯èƒ½ï¼‰**

```bash
# å‹•çš„Kå€¤ã‚’ä½¿ç”¨ï¼ˆæ¨å¥¨ï¼‰
npx ts-node rag-evaluator.ts export-tsv \
  --namespace "technical-fellows" \
  --stakeholders ./stakeholders.json \
  --output ./chunks-for-labeling.tsv

# å›ºå®šKå€¤ã‚’ä½¿ç”¨
npx ts-node rag-evaluator.ts export-tsv \
  --namespace "technical-fellows" \
  --stakeholders ./stakeholders.json \
  --output ./chunks-for-labeling.tsv \
  --k 15
```

**å‡ºåŠ›ã•ã‚Œã‚‹TSVã®å½¢å¼ï¼š**

| åˆ—å | èª¬æ˜ |
|------|------|
| query_id | ã‚¯ã‚¨ãƒªã®è­˜åˆ¥å­ |
| query | è‡ªå‹•ç”Ÿæˆã•ã‚ŒãŸã‚¯ã‚¨ãƒªæ–‡å­—åˆ— |
| stakeholder_id | ã‚¹ãƒ†ãƒ¼ã‚¯ãƒ›ãƒ«ãƒ€ãƒ¼ID |
| chunk_id | ãƒãƒ£ãƒ³ã‚¯ã®è­˜åˆ¥å­ |
| file_name | ãƒ•ã‚¡ã‚¤ãƒ«å |
| chunk_index | ãƒãƒ£ãƒ³ã‚¯ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ |
| rank | **æ¤œç´¢çµæœã®é †ä½ï¼ˆã‚·ã‚¹ãƒ†ãƒ ãŒæ±ºå®šï¼‰** |
| score | RRFã‚¹ã‚³ã‚¢ |
| content_preview | ãƒãƒ£ãƒ³ã‚¯å†…å®¹ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ |
| relevance_score | **ç©ºæ¬„ï¼ˆäººé–“ãŒãƒ©ãƒ™ãƒªãƒ³ã‚°ï¼‰** |

### convert-tsv - TSV â†’ JSONå¤‰æ›

ãƒ©ãƒ™ãƒªãƒ³ã‚°æ¸ˆã¿TSVã‚’Ground Truth JSONã«å¤‰æ›ã—ã¾ã™ã€‚

```bash
npx ts-node rag-evaluator.ts convert-tsv \
  --input ./labeled.tsv \
  --output ./ground-truth.json \
  --description "è©•ä¾¡ç”¨Ground Truth v1.0"
```

### evaluate-rrf - RRFæ–¹å¼ã§è©•ä¾¡ï¼ˆæ¨å¥¨ï¼‰

å®Ÿéš›ã®ãƒ„ãƒ¼ãƒ«ã¨åŒã˜RRFæ¤œç´¢æ–¹å¼ãƒ»å‹•çš„Kå€¤ã§è©•ä¾¡ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

```bash
# å‹•çš„Kå€¤ã‚’ä½¿ç”¨ï¼ˆæ¨å¥¨ï¼‰
npx ts-node rag-evaluator.ts evaluate-rrf \
  --namespace "technical-fellows" \
  --stakeholders ./stakeholders.json \
  --ground-truth ./ground-truth.json \
  --output ./evaluation-results
```

### show-queries - ã‚¯ã‚¨ãƒªç”Ÿæˆç¢ºèª

ã‚¹ãƒ†ãƒ¼ã‚¯ãƒ›ãƒ«ãƒ€ãƒ¼ã‹ã‚‰ç”Ÿæˆã•ã‚Œã‚‹ã‚¯ã‚¨ãƒªã‚’ç¢ºèªã—ã¾ã™ã€‚

```bash
npx ts-node rag-evaluator.ts show-queries \
  --stakeholders ./stakeholders.json
```

---

## ğŸ“Š è©•ä¾¡æŒ‡æ¨™

| æŒ‡æ¨™ | èª¬æ˜ | æ•°å¼ |
|------|------|------|
| **Precision@K** | å–å¾—ã—ãŸKä»¶ã®ã†ã¡ã€æ­£è§£ã ã£ãŸå‰²åˆ | `\|Hit(K)\| / \|Retrieved(K)\|` |
| **Recall@K** | æ­£è§£ãƒãƒ£ãƒ³ã‚¯ã®ã†ã¡ã€Kä»¶ä»¥å†…ã«å–å¾—ã§ããŸå‰²åˆ | `\|Hit(K)\| / \|Relevant\|` |
| **F1@K** | Precisionã¨Recallã®èª¿å’Œå¹³å‡ | `2 * P * R / (P + R)` |
| **MRR** | æœ€åˆã®æ­£è§£ãŒå‡ºç¾ã—ãŸé †ä½ã®é€†æ•°ã®å¹³å‡ | `1/\|Q\| * Î£(1/rank)` |
| **nDCG@K** | æ­£è§£ã®é †ä½ã«é‡ã¿ã‚’ã¤ã‘ãŸå“è³ªæŒ‡æ¨™ | `DCG@K / IDCG@K` |
| **Coverage** | ã©ã‚Œã ã‘å¤šæ§˜ãªãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰æƒ…å ±ã‚’å–å¾—ã§ããŸã‹ | `\|Files_hit\| / \|Files_all\|` |
| **Kå€¤é”æˆç‡** | ç›®æ¨™ã®Kä»¶ã‚’å–å¾—ã§ããŸã‚¯ã‚¨ãƒªã®å‰²åˆ | `Success / \|Queries\|` |

---

## ğŸ“ é–¢é€£åº¦ã‚¹ã‚³ã‚¢ã®åŸºæº–

ãƒ©ãƒ™ãƒªãƒ³ã‚°æ™‚ã®ã‚¹ã‚³ã‚¢åŸºæº–ï¼š

| ã‚¹ã‚³ã‚¢ | æ„å‘³ | èª¬æ˜ |
|--------|------|------|
| **0** | ç„¡é–¢ä¿‚ | ã‚¯ã‚¨ãƒªã¨å…¨ãé–¢ä¿‚ãªã„å†…å®¹ |
| **1** | ä½é–¢é€£ | é–“æ¥çš„ã«é–¢é€£ã™ã‚‹å†…å®¹ï¼ˆèƒŒæ™¯æƒ…å ±ãªã©ï¼‰ |
| **2** | ä¸­é–¢é€£ | éƒ¨åˆ†çš„ã«é–¢é€£ã™ã‚‹å†…å®¹ï¼ˆä¸€éƒ¨ã®æƒ…å ±ãŒè©²å½“ï¼‰ |
| **3** | é«˜é–¢é€£ | ç›´æ¥çš„ã«é–¢é€£ã™ã‚‹å†…å®¹ï¼ˆã‚¯ã‚¨ãƒªã®å›ç­”ã«å¿…é ˆï¼‰ |

---

## ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ

```
rag-evaluation/
â”œâ”€â”€ rag-evaluator.ts       # ãƒ¡ã‚¤ãƒ³ã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼ˆCLIã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆï¼‰
â”œâ”€â”€ metrics.ts             # è©•ä¾¡æŒ‡æ¨™è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯
â”œâ”€â”€ tsv-exporter.ts        # TSVå…¥å‡ºåŠ›ãƒ»Ground Truthå¤‰æ›
â”œâ”€â”€ query-enhancer-copy.ts # ã‚¯ã‚¨ãƒªç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯ï¼ˆSSRãƒ„ãƒ¼ãƒ«ã¨åŒã˜ï¼‰
â”œâ”€â”€ rag-utils-copy.ts      # å‹•çš„Kå€¤è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆSSRãƒ„ãƒ¼ãƒ«ã¨åŒã˜ï¼‰
â”œâ”€â”€ types.ts               # å‹å®šç¾©
â”œâ”€â”€ package.json           # ä¾å­˜é–¢ä¿‚
â”œâ”€â”€ tsconfig.json          # TypeScriptè¨­å®š
â”œâ”€â”€ stakeholders.json      # ã‚¹ãƒ†ãƒ¼ã‚¯ãƒ›ãƒ«ãƒ€ãƒ¼å®šç¾©ï¼ˆSSRãƒ„ãƒ¼ãƒ«ã¨åŒã˜ï¼‰
â””â”€â”€ README.md              # ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«
```

---

## ğŸ” rankã¨relevance_scoreã®é•ã„

| åˆ—å | æ„å‘³ | èª°ãŒæ±ºã‚ã‚‹ï¼Ÿ |
|------|------|-------------|
| **rank** | æ¤œç´¢çµæœã®é †ä½ï¼ˆ1ä½ã€œKä½ï¼‰ | **ã‚·ã‚¹ãƒ†ãƒ **ï¼ˆPinecone + RRFï¼‰ |
| **relevance_score** | å®Ÿéš›ã®é–¢é€£åº¦ï¼ˆ0ã€œ3ï¼‰ | **äººé–“**ï¼ˆãƒ©ãƒ™ãƒªãƒ³ã‚°ä½œæ¥­ï¼‰ |

**è©•ä¾¡ã®ç›®çš„**: rankã¨relevance_scoreãŒã©ã‚Œã ã‘ä¸€è‡´ã—ã¦ã„ã‚‹ã‹ã‚’æ¸¬å®šã—ã¾ã™ã€‚

ç†æƒ³çš„ãªçŠ¶æ…‹ï¼š
```
rank=1 â†’ relevance_score=3ï¼ˆé«˜é–¢é€£ï¼‰  âœ…
rank=2 â†’ relevance_score=3ï¼ˆé«˜é–¢é€£ï¼‰  âœ…
...
rank=10 â†’ relevance_score=0ï¼ˆç„¡é–¢ä¿‚ï¼‰ âœ…
```

---

## âš ï¸ æ³¨æ„äº‹é …

1. **æ‰‹å‹•ãƒˆãƒªã‚¬ãƒ¼**: ã™ã¹ã¦ã®ã‚³ãƒãƒ³ãƒ‰ã¯æ‰‹å‹•ã§CLIå®Ÿè¡Œã—ã¾ã™
2. **ç’°å¢ƒå¤‰æ•°**: Pinecone/OpenAI APIã‚­ãƒ¼ãŒå¿…è¦ã§ã™
3. **namespace**: è©•ä¾¡å¯¾è±¡ã®ã‚¹ãƒ†ãƒ¼ã‚¯ãƒ›ãƒ«ãƒ€ãƒ¼ã”ã¨ã«namespaceã‚’æŒ‡å®šã—ã¦ãã ã•ã„