# Safety Status Report (SSR) 自動生成ツール

GSNファイルや議事録などのドキュメントから、AIとRAG（Retrieval-Augmented Generation）を活用してステークホルダー別のSafety Status Report（安全性状況報告書）を自動生成するNext.jsアプリケーションです。

## 主な機能

- **ファイルアップロード**: PDF、テキスト、CSV、Excel、Word、画像ファイル（JPG, PNG等）など多様な形式に対応
- **OCR機能**: Google Cloud Vision APIを使用した画像・画像ベースPDFからのテキスト抽出
- **大容量ファイル対応 (AWS S3)**: 4MBを超えるファイルをAWS S3経由で安全に処理
- **RAG機能(Pinecone)**: 大量のドキュメントから関連情報を効率的に抽出
- **ブラウザID分離機能**: 各ブラウザ/ユーザーごとに独立したデータ空間を提供（ログイン不要）
- **知識ベース管理**: UIから知識ベースの構築・削除が可能
- **動的な情報抽出**: ドキュメント量とステークホルダーに応じた最適な情報量の調整
- **全文使用機能**: 重要なファイルを確実にAIに渡すための全文コンテキスト使用オプション
- **ステークホルダー別レポート**: カスタマイズ可能なステークホルダーグループ向けのレポート生成
- **ステークホルダー管理**: ステークホルダーの追加・編集・削除機能
- **構成カスタマイズ機能**: レポート構成の追加・編集・削除機能
- **レトリック戦略**: ステークホルダーに応じた説得手法（データ駆動型、論理的推論型など）の自動選択
- **AI活用**: Claude APIを使用した高品質なレポート作成
- **多様な出力形式**: PDF、HTML、Word（docx）形式でのダウンロード
- **編集機能**: 生成後のレポートを手動で編集可能
- **ダークモード機能**: ダークモードに切り替え可能

## 始め方

### 前提条件

- Node.js 18.0.0以上
- npm または yarn
- Anthropic Claude APIキー
- OpenAI APIキー（エンベディング用）
- Google Cloud Vision APIキー（OCR用）
- **AWS S3バケット**（大容量ファイル処理用）
- Pinecone APIキー

### インストール手順

#### 1. リポジトリのクローン
```bash
git clone https://github.com/CSTmatsunolab/safety-status-report-tool.git
cd safety-status-report-tool
```

#### 2. 依存関係のインストール
```bash
npm install
```

#### 3. 環境変数の設定

プロジェクトルートに`.env.local`ファイルを作成し、以下を追加：
```bash
# 必須
ANTHROPIC_API_KEY=your_claude_api_key_here
OPENAI_API_KEY=your_openai_api_key_here

# OCR機能用（画像/画像ベースPDF処理に必要）
GOOGLE_CLOUD_VISION_KEY='{ "type": "service_account", ... }' # Google CloudからダウンロードしたJSONキーの内容

# ベクトルストア設定
VECTOR_STORE=pinecone # または 'memory'（デフォルトはpinecone）

# Pinecone使用時
PINECONE_API_KEY=your_pinecone_api_key
PINECONE_INDEX_NAME=ssr-index
CLEAR_NAMESPACE_BEFORE_INSERT=false # trueにすると再構築時に既存データをクリア（オプション）

# AWS S3設定 (4MB以上のファイル処理に必要)
AWS_REGION=your_s3_bucket_region
AWS_ACCESS_KEY_ID=your_aws_access_key_id
AWS_SECRET_ACCESS_KEY=your_aws_secret_access_key
AWS_S3_BUCKET_NAME=your_s3_bucket_name

# S3クリーンアップAPI用 (Vercel Cronなどで使用)
CLEANUP_AUTH_TOKEN=your_secure_random_token
```

4. **Google Cloud Vision APIのセットアップ

- Google Cloud Consoleでプロジェクトを作成し、Vision APIを有効化します
- サービスアカウントキー（JSON）を作成し、`GOOGLE_CLOUD_VISION_KEY`環境変数に設定します

#### 5. AWS S3のセットアップ

- AWSコンソールでS3バケットを作成します
- IAMユーザーを作成し、S3バケットへの `PutObject`, `GetObject`, `DeleteObject`, `ListBucket` 権限を付与します
- バケットのCORS設定を行い、アプリケーションのドメインからの `PUT` リクエストを許可します
- IAMユーザーのアクセス情報を `.env.local` に設定します

#### 6. 開発サーバーの起動
```bash
npm run dev
```

ブラウザで http://localhost:3000 を開く

### ビルドと本番環境

```bash
# プロダクションビルド
npm run build

# 本番サーバーの起動
npm start
```

## 使い方

### 基本的な使用フロー

1. **ドキュメントのアップロード**: GSNファイル、議事録、仕様書などをアップロードします
2. **ステークホルダーの選択**: デフォルトまたはカスタムステークホルダーから対象を選択します
3. **構成の選択**: 推奨構成、またはカスタム構成を選択します
4. **ナレッジベース構築**: 「知識ベースを構築」ボタンをクリック（RAG使用時）
5. **レポート生成**: 「レポートを生成」ボタンをクリックします
6. **レポートの編集・出力**: 生成されたレポートを編集、またはPDF、HTML、Word形式でダウンロードします

### ブラウザID分離機能

#### 概要
ログイン機能なしで、各ブラウザ/ユーザーが独立したデータ空間を持つことができます。異なるユーザーが同じステークホルダーを選択しても、データが混在することはありません。

#### 仕組み
- 各ブラウザに一意のUUID（ブラウザID）が自動生成されlocalStorageに保存
- Pineconeのネームスペースが `{stakeholderId}_{browserId}` の形式で作成
- 例：「CxO」を選択 → `cxo_12345678-uuid-here` のネームスペースを使用

#### ネームスペース形式
- **定義済みステークホルダー**: `{stakeholder_id}_{browser_id}`
  - 例: `cxo_12345678-uuid`, `architect_87654321-uuid`
- **カスタムステークホルダー**: `custom_{custom_id}_{browser_id}`
  - 例: `custom_myproject_12345678-uuid`

### 知識ベース管理機能（新機能）

#### RAG知識ベースの削除
UIから直接、構築した知識ベースを削除できるようになりました。

##### 削除方法
1. ステークホルダーを選択
2. 「RAG知識ベース」セクションの削除ボタンをクリック
3. 確認ダイアログで削除対象を確認
4. OKをクリックして削除実行

##### 削除の特徴
- **安全な削除**: 選択中のステークホルダー・ブラウザIDの組み合わせのデータのみ削除
- **他のデータは保護**: 他のユーザーや他のステークホルダーのデータには影響なし
- **いつでも削除可能**: 構築前・構築後・エラー時でも削除ボタンが利用可能
- **再構築可能**: 削除後も同じネームスペースで再構築可能

### 全文使用機能について

#### 概要
アップロードした各ファイルに対して「全文使用」トグルスイッチを提供。これにより、特定のファイルの全内容を確実にAIのコンテキストに含めることができます。
**GSNファイルはこれをONにすることを推奨します。**

#### 使用推奨ケース
- **数値データ**: CSV、Excelファイルなど数値が重要なファイル
- **GSNファイル**: 構造的な関係性が重要な文書
- **小容量ファイル**: 5,000文字以下のファイル
- **重要な仕様書**: 詳細な技術仕様が記載された文書

#### 動作の仕組み
- **全文使用ON**: ファイルの全内容をそのままAIに渡す（RAGを経由しない）
- **全文使用OFF**: RAGによって関連部分のみを抽出してAIに渡す（デフォルト）

#### コンテキスト制限
- 技術者向け: 最大80,000文字
- その他: 最大50,000文字
- 全文使用ファイルの合計文字数がこの制限を超えないよう注意してください

#### 全文使用機能の注意点

##### メモリ不足エラー
大量のファイルで全文使用を有効にすると、コンテキスト制限を超える可能性があります。
- エラーメッセージが表示された場合は、一部のファイルの全文使用を無効にしてください
- 優先度の高いファイルのみ全文使用を有効にすることを推奨

##### パフォーマンス
- 全文使用を有効にしたファイルが多いと、レポート生成に時間がかかる場合があります
- RAGを使用する方が、大量の文書から効率的に情報を抽出できます

### GSNファイルの明示的な指定

#### 新機能: GSNチェックボックス
各アップロードファイルに「GSN」チェックボックスが追加され、GSNファイルを明示的に指定できるようになりました。

#### 使用方法
1. ファイルをアップロード
2. GSNファイルの横にある「GSN」チェックボックスにチェック
3. レポート構成にGSN専用セクションが自動追加される


### レポート構成のカスタマイズ機能

#### カスタム構成の作成
レポート生成時に、独自のレポート構成を作成・保存・管理できるようになりました。

##### 機能詳細
- **ドラッグ&ドロップ**: セクションの順序をドラッグで簡単に並び替え
- **動的セクション管理**: セクションの追加・削除が自由自在
- **永続化**: 作成したカスタム構成はローカルストレージに保存され、次回以降も利用可能
- **削除機能**: 不要になったカスタム構成は個別に削除可能

##### 使用方法
1. レポート構成選択画面で「カスタム構成を作成」をクリック
2. 構成名と説明を入力
3. セクション名を順番に入力（ドラッグで順序変更可能）
4. 「この構成を使用」をクリック

#### GSNセクションの自動追加
GSNファイルがアップロードされると、選択した構成に応じて適切なGSN分析セクションが自動的に追加されます。

##### 構成別のGSN追加セクション
- **経営向けレポート**: 
  - GSN目標達成状況サマリー
  - 主要リスク制御戦略
- **技術詳細レポート**: 
  - GSN構造分析
  - Goal-Strategy-Evidence対応表
  - 技術的ギャップ分析
- **問題解決型レポート**: 
  - 未達成Goal分析
  - 対策Strategy提案
- **リスク重視レポート**: 
  - GSNコンテキスト分析
  - 未解決Assumptionリスト

#### 動的構成プレビュー
- GSNファイルの有無により、最終的なレポート構成がリアルタイムで更新
- GSN分析セクションは青色のバッジで視覚的に識別
- 総章数とGSNセクション数が明確に表示

#### 推奨ステークホルダーの可視化
各レポート構成に推奨ステークホルダーが設定され、UIで確認できるようになりました。

##### 拡張された推奨マッピング
| レポート構成 | 推奨ステークホルダー |
|---|---|
| **経営向けレポート** | CxO/経営層, 事業部門 |
| **技術詳細レポート** | 技術専門家, アーキテクト, R&D |
| **データ駆動型** | CxO/経営層, 事業部門, 財務部門, 営業部門 |
| **問題解決型** | 製品部門, リスク・安全管理者, 品質保証部門, オペレーション部門 |
| **ナラティブ型** | プロジェクトマネージャー, マーケティング部門, 人事部門 |
| **リスク重視** | リスク・安全管理者, セキュリティ部門, コンプライアンス部門, 法務部門 |

#### インタラクティブな情報表示
- 情報アイコン（ⓘ）をクリックで詳細情報を展開表示
- 推奨ステークホルダーとGSNセクションを統合表示
- モバイルフレンドリーなタップ操作対応

### カスタムステークホルダーIDの拡張

### OCR機能について

- **対応形式**: 画像ファイル（JPG, PNG等）、画像ベースPDF
- **仕組み**: PDFはまず埋め込みテキストを試し、文字が少ない場合（100文字未満）にGoogle Cloud Vision APIでOCRを実行します。画像ファイルは直接OCRを実行します
- **GSN処理**: GSNファイルと判定された場合、OCRテキストからGSN要素（G1, S1等）を識別し、自動で整形します

### RAG機能の詳細

#### 検索クエリの高度化
システムは単純なキーワード検索ではなく、以下の高度な検索戦略を採用：

##### 自動生成される5つの検索パターン
1. **基本クエリ**: ロールと関心事の組み合わせ
2. **関心事フォーカス**: ロールを除いた関心事のみ
3. **同義語展開**: 「リスク管理」→「ハザード」「危険評価」など
4. **ロール特化用語**: 技術者には「GSN アシュアランスケース」を追加
5. **英語クエリ**: 英語文書対応のための自動翻訳

##### 多言語対応
- 入力言語を自動判定（日本語/英語/混在）
- 英語役職を日本語に自動変換（例：Product Manager → プロダクトマネージャー）
- 関心事の自動翻訳（例：cost reduction → コスト削減）
- 技術用語（CI/CD、Kubernetes等）はそのまま保持

#### 動的な情報抽出
- チャンク総数の30%を基準に、関連情報を動的に抽出
- **技術系ステークホルダー**（Technical Fellows、Architect、R&D）: 1.2倍に調整
- **経営系ステークホルダー**（CxO、Business）: 0.7倍に調整
- **製品系ステークホルダー**（Product）: 1.0倍（標準）
- ベクトルストアの種類に応じた上限設定（Pinecone: 50、メモリ: 20）

#### 適応的取得アルゴリズム
動的K値（取得文書数）を確実に取得するための3段階検索：
- **Phase 1**: 初期取得（K値の100%を目標）
- **Phase 2**: 拡張取得（不足時は150%まで拡張）
- **Phase 3**: 深層取得（さらに200%まで検索）

文書総数の80%を上限として設定し、重複を除去した上で正確にK件を返却。
達成率90%以上を維持。

#### カスタムステークホルダーの自動最適化
役割名から分野を自動推測し、専門検索用語を追加：
- 品質/QA → 「品質保証、テスト、バグ、検証」
- セキュリティ → 「脆弱性、攻撃、防御、ゼロトラスト」
- データ分析 → 「BI、データガバナンス、KPI」

#### ベクトルストアの選択
- **Pinecone**（デフォルト）: クラウドベース、大規模データに最適、コサイン類似度使用、永続化
- **メモリ**: 開発・テスト用、永続化なし、サーバー再起動でデータ消失

### ステークホルダー管理

ステークホルダー設定ページ（`/stakeholder-settings`）では、以下の操作が可能です：

#### ステークホルダーの追加
1. 「新しいステークホルダーを追加」ボタンをクリック
2. 以下の情報を入力：
   - **ID**: ステークホルダーのID
   - **役職名**: ステークホルダーの役職（例：プロジェクトマネージャー）
   - **関心事**: ステークホルダーが重視する項目（複数追加可能）
3. 「保存」ボタンをクリック

#### ステークホルダーの削除
1. 削除したいステークホルダーの「削除」ボタンをクリック
2. 確認ダイアログで「削除」を選択

**注意**: デフォルトのステークホルダー（初期設定の6つ）は削除できません。

#### 新しいステークホルダーID
カスタムステークホルダー作成時に、以下のIDが自動的に認識され、適切な構成が推奨されます：

#### ID命名規則
- **使用可能文字**: 英数字、ハイフン（-）、アンダースコア（_）
- **文字数**: 3〜30文字
- **大文字小文字**: 区別される（Case Sensitive）
- **プレフィックス**: カスタムIDには自動的に`custom_`が付与

### レポート生成の詳細機能

#### レトリック戦略
システムはステークホルダーの役職と関心事に基づいて、最適なレトリック戦略を自動選択します：

- **データ駆動型説得法**: CxO、事業部門、製品部門向け
- **論理的推論型**: 技術専門家、アーキテクト向け  
- **権威依拠型**: R&D部門向け
- **感情訴求型**: 営業・マーケティング向け
- **問題解決型**: リスク・安全管理者向け
- **ナラティブ型**: プロジェクトマネージャー向け

#### レポート形式
- **文体**: すべてのレポートは「である調」で統一（です・ます調は使用しない）
- **図表指示**: レポート内で`[図表: 説明]`形式で図表の挿入位置を指示
- **構成**: ステークホルダーとレトリック戦略に応じて最適化された章構成

### RAGログ機能

RAG検索の結果は`logs/rag/`ディレクトリにJSON形式で自動保存されます。検索クエリ、取得したチャンク、スコアなどを確認でき、デバッグに役立ちます。

## フォルダ構成
```
safety-status-report-tool/
├── src/
│   ├── app/
│   │   ├── api/
│   │   │   ├── build-knowledge-base/
│   │   │   │   └── route.ts          # ナレッジベース構築API（ブラウザID対応）
│   │   │   ├── delete-knowledge-base/
│   │   │   │   └── route.ts          # ナレッジベース削除API
│   │   │   ├── generate-report/
│   │   │   │   └── route.ts          # レポート生成API（ブラウザID対応）
│   │   │   ├── export-html/
│   │   │   │   └── route.ts          # HTML出力API
│   │   │   ├── export-docx/
│   │   │   │   └── route.ts          # Word出力API
│   │   │   ├── export-pdf/
│   │   │   │   └── route.ts          # PDF出力API
│   │   │   ├── pdf-extract/
│   │   │   │   └── route.ts          # PDFテキスト抽出API（OCR対応）
│   │   │   ├── google-vision-ocr/
│   │   │   │   └── route.ts          # 画像OCR API
│   │   │   │── excel-extract/
│   │   │   │   └── route.ts          # Excelテキスト抽出API
│   │   │   │── docx-extract/
│   │   │   │   └── route.ts          # Wordテキスト抽出API
│   │   │   ├── s3-upload/            # S3アップロード
│   │   │   ├── s3-process/           # S3上のファイル処理API 
│   │   │   └── s3-cleanup/           # S3クリーン
│   │   │
│   │   ├── components/
│   │   │   ├── FileUpload.tsx               # ファイルアップロードUI
│   │   │   ├── StakeholderSelect.tsx        # ステークホルダー選択UI
│   │   │   ├── ReportPreview.tsx            # レポートプレビュー
│   │   │   ├── ReportEditor.tsx             # レポート編集機能
│   │   │   ├── ReportStructureSelector.tsx  # カスタム構成機能
│   │   │   ├── ThemeProvider.tsx            # テーマ管理(next-themesプロバイダーラッパー)
│   │   │   └── ThemeToggle.tsx              # ライト/ダーク/システムモード切り替えUI
│   │   │
│   │   ├── stakeholder-settings/
│   │   │   └── page.tsx             # ステークホルダー設定メインページ
│   │   │
│   │   ├── layout.tsx               # アプリケーションレイアウト
│   │   ├── page.tsx                 # メインページ（ブラウザID対応）
│   │   └── globals.css              # グローバルスタイル
│   │
│   ├── lib/
│   │   ├── config/
│   │   │   └── constants.ts              # アプリケーション設定値
│   │   ├── browser-id.ts                 # ブラウザID管理（新規追加）
│   │   ├── stakeholders.ts               # ステークホルダー管理ロジック
│   │   ├── vector-store.ts               # ベクトルストア管理（ブラウザID対応）
│   │   ├── embeddings.ts                 # エンベディング設定
│   │   ├── google-cloud-auth.ts          # Google Cloud認証
│   │   ├── text-processing.ts            # テキスト処理ユーティリティ
│   │   ├── vision-api-utils.ts           # Vision APIエラーハンドリング
│   │   ├── pdf-exporter.ts               # PDF出力処理
│   │   ├── report-prompts.ts             # プロンプトテンプレート
│   │   ├── rag-utils.ts                  # RAGユーティリティ（ログ機能含む）
│   │   ├── rhetoric-strategies.ts        # レトリック戦略
│   │   ├── query-enhancer.ts             # 検索クエリ拡張機能
│   │   └── report-structures.ts          # レポート構成管理
│   │
│   └── types/
│       └── index.ts                 # TypeScript型定義
│
├── logs/
│   └── rag/                        # RAGログ保存ディレクトリ
│       ├── rag_*.json              # 詳細ログファイル
│       └── summary.jsonl           # サマリーログ
│
├── public/
├── .env.local                       # 環境変数（Gitには含めない）
├── .gitignore
├── next.config.js                   # Next.js設定
├── package.json
├── tailwind.config.ts              # Tailwind CSS設定
├── tsconfig.json                   # TypeScript設定
└── README.md
```

## 技術スタック

- **フレームワーク**: Next.js 14 (App Router)
- **言語**: TypeScript
- **スタイリング**: Tailwind CSS
- **AI/LLM**: 
  - Anthropic Claude API (Claude 3 Haiku) - レポート生成
  - OpenAI API (text-embedding-3-small) - エンベディング
  - Google Cloud Vision API - OCR処理
- **RAG/ベクトルストア**:
  - Pinecone（デフォルト）- 永続化、大規模データ対応
  - LangChain - ベクトルストア抽象化
- **ファイル処理**:
  - AWS S3 (SDK V3)
  - PDF生成: Puppeteer
  - PDF抽出: pdf-parse-new
  - OCR: @google-cloud/vision
  - Excel処理: xlsx
  - Word抽出: mammoth
  - Word生成: docx
- **UI**: React 18
- **データ永続化**: 
  - ローカルストレージ（カスタムステークホルダー用、ブラウザID）
  - Pineconeベクトルストア（ドキュメント用）
  - ファイルシステム（RAGログ用）

## トラブルシューティング

### ブラウザID関連

#### ブラウザIDがリセットされた場合
- localStorageがクリアされるとブラウザIDが新規生成されます
- 以前のデータにアクセスできなくなりますが、新しいIDで再構築可能です
- プライベートブラウジングモードでは永続化されません

#### データが見つからない場合
- ブラウザのコンソールで`localStorage.getItem('ssr-browser-id')`を実行してIDを確認
- Pineconeダッシュボードで対応するネームスペースを確認
- 異なるブラウザ/デバイスからは他のデータにアクセスできません

### 知識ベース削除関連

#### 削除ボタンを2回押した場合
- 2回目は「データは既に削除されています」というメッセージが表示されます
- これは正常な動作で、エラーではありません

#### 削除後にデータが残っている場合
- Pineconeの反映に時間がかかる場合があります（通常1-2秒）
- 数秒待ってからページをリロードしてください
- それでも残っている場合は、Pineconeダッシュボードで直接確認してください

### レポートが期待通りに生成されない場合

#### レトリック戦略が適切でない場合
- カスタムステークホルダーの場合、役職名に「技術」「エンジニア」「経営」「営業」などのキーワードを含めることで、より適切な戦略が選択されます

#### GSN分析が不十分な場合  
- GSNファイルは「全文使用」を有効にすることを推奨
- GSNチェックボックスをONにして明示的に指定
- ファイル名に"GSN"を含めることで、自動的にGSN用の処理が適用されます

### 検索結果が不十分な場合

#### 症状
- 重要な情報が検索されない
- 関連性の低い文書が多く含まれる

#### 対処法
1. **ステークホルダーの役割を明確に記載**
   - 「技術部門」より「ソフトウェア開発部門」の方が精度向上
   - 英語名でも自動的に日本語検索に対応

2. **関心事を具体的に設定**
   - 「品質」より「ソフトウェア品質保証」が効果的
   - 複数の関心事を設定（最大3つが優先的に使用）

3. **全文使用オプションの活用**
   - 確実に含めたい重要文書は「全文使用」を有効化

#### 検索ログの確認
`logs/rag/`フォルダに保存される検索ログで以下を確認可能：
- 生成された拡張クエリ
- 各クエリでの検索結果
- K値達成率
- 最終的に選択された文書リスト

### OCR関連のエラー

- **認証エラー**: `GOOGLE_CLOUD_VISION_KEY`が正しいか、Vision APIが有効か確認してください
- **クォータ制限**: 無料枠の制限に達した可能性があります。時間をおいて試すか、画像（PNG/JPG）に変換してアップロードしてください
- **PDFページ数制限**: 4MB未満のPDFはOCR処理が最大5ページに制限されます

### AWS S3関連エラー

- **認証エラー (403)**: AWSのIAMキー、シークレット、リージョン、バケット名が正しいか、CORS設定が許可されているか確認してください
- **ファイルアップロード失敗**: `AWS_S3_BUCKET_NAME` と `AWS_REGION` が正しいか、IAMユーザーが `PutObject` 権限を持っているか確認してください

### 大きなファイルの処理

- 4MB以上のファイルはAWS S3を経由します。アップロードと処理に時間がかかる場合があります
- 画像ファイルは10MB以下を推奨します

## セキュリティ考慮事項

- **ブラウザID**: クライアント側で生成されるため、セキュリティが重要な環境では適切な認証システムと組み合わせてください
- **データ分離**: ブラウザIDによる分離は完全ですが、本番環境では追加のアクセス制御を検討してください
- **Pinecone APIキー**: 環境変数で管理し、フロントエンドには露出させないでください
- **S3バケット**: 適切なIAM権限とバケットポリシーを設定してください

## 今後の開発予定

- ユーザー認証システムの追加
- チーム機能（複数ユーザーでのデータ共有）
- バックアップ・復元機能
- レポートテンプレートの拡充
- 多言語対応の強化